<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>The Night‚Äôs Choice</title>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0b0b0f">
<style>
  :root{
    --bg:#0b0b0f; --panel:#13131a; --panel2:#181824;
    --accent:#d79ab8; --accent2:#7ad1cc;
    --text:#f2f2f5; --muted:#a9abbb; --line:#24253a;
  }
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,Inter,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,rgba(11,11,15,.98),rgba(11,11,15,.7) 70%,rgba(11,11,15,0));backdrop-filter:blur(8px);border-bottom:1px solid #1b1c2a}
  .topbar{max-width:1100px;margin:0 auto;display:flex;gap:10px;align-items:center;justify-content:space-between;padding:calc(env(safe-area-inset-top) + 18px) 14px 12px}
  .title-tappable{font-weight:700;letter-spacing:.4px;font-size:20px;padding:8px 10px;border-radius:8px}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

  /* Upload control from your stable build */
  label.upload{display:inline-flex;align-items:center;gap:8px;border:1px dashed #34354a;padding:8px 10px;border-radius:10px;background:var(--panel2);cursor:pointer}
  input[type=file]{display:none}

  button,select,textarea,input{background:var(--panel);color:var(--text);border:1px solid #222331;border-radius:10px;padding:10px 12px;font-size:14px}
  button.primary{background:linear-gradient(180deg,#272737,#1b1b28);border-color:#2b2c3d}
  button:disabled{opacity:.5}
  .pill{background:#1a1a28;border:1px solid #2a2b40;border-radius:999px;padding:6px 10px;font-size:12px;color:#ddd}

  .wrap{max-width:1100px;margin:0 auto;padding:0 14px 60px}
  .machine{margin-top:14px;background:radial-gradient(1200px 600px at 50% -200px,#1a1a26,#0e0e14 70%);border:1px solid var(--line);border-radius:18px;padding:16px;box-shadow:0 10px 40px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.02)}
  .reels{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .reel{height:160px;background:linear-gradient(180deg,#151521,#0f0f16);border:1px solid #23243a;border-radius:12px;overflow:hidden;position:relative}
  .strip{position:absolute;inset:0;display:flex;flex-direction:column;gap:0;will-change:transform,filter}
  .cell{height:160px;display:flex;align-items:center;justify-content:center}
  .cell img{height:100%;width:100%;object-fit:cover;border-radius:10px}

  .reveal-name{margin-top:12px;text-align:center;font-weight:700;color:var(--accent)}
  .reveal-big{margin-top:8px;border:1px solid #24253a;border-radius:14px;background:#0f0f15;min-height:42vh;display:grid;place-items:center;overflow:hidden}
  .reveal-big img{max-width:100%;max-height:100%;display:block}

  /* NEW: Stars below reveal */
  .reveal-stars{margin:10px auto 0;max-width:680px;display:grid;gap:6px}
  .reveal-stars .line{display:flex;align-items:center;gap:10px;justify-content:center;font-size:13px;color:var(--muted)}
  .reveal-stars .stars{font-size:16px;letter-spacing:1px;cursor:pointer}

  .toolbar{display:flex;gap:10px;align-items:center;justify-content:center;margin-top:10px}
  .countdown{font-variant-numeric:tabular-nums}
  .hidden{display:none !important}
</style>
</head>
<body>
<header>
  <div class="topbar">
    <div class="title-tappable">The Night‚Äôs Choice</div>
    <div class="controls">
      <!-- Upload (kept from working build) -->
      <label class="upload">
        ‚ûï Upload
        <input id="fileInput" type="file" accept="image/*" multiple>
      </label>

      <!-- NEW: Restrict by category -->
      <label class="pill" style="display:flex;align-items:center;gap:6px">
        üéØ
        <select id="mainRestrict" title="Restrict Category"></select>
      </label>

      <!-- Timer -->
      <label class="pill" style="display:flex;align-items:center;gap:6px">
        ‚è±Ô∏è
        <select id="timerSelect" title="Timer">
          <option value="0">Off</option>
          <option value="1">1 min</option>
          <option value="2">2 min</option>
          <option value="3">3 min</option>
          <option value="4">4 min</option>
          <option value="5">5 min</option>
        </select>
      </label>

      <button id="spinBtn" class="primary">üé∞ Spin</button>
    </div>
  </div>
</header>

<div class="wrap">
  <section class="machine">
    <div class="reels" id="reels">
      <div class="reel"><div class="strip"></div></div>
      <div class="reel"><div class="strip"></div></div>
      <div class="reel"><div class="strip"></div></div>
    </div>

    <div id="revealName" class="reveal-name"></div>

    <div id="revealBig" class="reveal-big hidden">
      <img id="revealImg" alt="">
    </div>

    <!-- NEW: meters -->
    <div class="reveal-stars">
      <div class="line"><span>Difficulty</span> <span id="diffStars" class="stars">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</span></div>
      <div class="line"><span>Her-O</span>      <span id="herStars"  class="stars">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</span></div>
      <div class="line"><span>His-O</span>      <span id="himStars"  class="stars">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</span></div>
    </div>

    <div class="toolbar">
      <span id="countdown" class="countdown"></span>
      <button id="skipBtn" class="pill" style="display:none">Skip</button>
    </div>
  </section>
</div>

<script>
/* ===== Basic config kept minimal ===== */
const CATEGORIES = ["Missionary","Woman-on-top","Oral for Her","Oral for Him","Sitting","Standing","Side-by-Side","Deep Penetration","69","Rear Entry","BDSM for Lovers","Adventurous"];
const SPIN_DURATION_MS = 6000;

/* ===== Storage keys ===== */
const DB_NAME='nights-choice-db', DB_STORE='images';
const LSK_RIG_CAT='nc_rigCat';
const LSK_RATINGS='nc_ratings';
const LSK_TIMER='nc_timer';

/* ===== State ===== */
let db, IMAGES=[], URLS=new Map();
let rigCategory = JSON.parse(localStorage.getItem(LSK_RIG_CAT) || '""') || '';
let ratings = JSON.parse(localStorage.getItem(LSK_RATINGS) || '{}'); // { id: {diff,her,him} }
let timerMinutes = +JSON.parse(localStorage.getItem(LSK_TIMER) || '0') || 0;

/* ===== UI refs ===== */
const fileInput = document.getElementById('fileInput');
const mainRestrict = document.getElementById('mainRestrict');
const timerSelect = document.getElementById('timerSelect');
const spinBtn = document.getElementById('spinBtn');
const countdownEl = document.getElementById('countdown');
const skipBtn = document.getElementById('skipBtn');
const revealNameEl = document.getElementById('revealName');
const revealBig = document.getElementById('revealBig');
const revealImg = document.getElementById('revealImg');
const diffStarsEl = document.getElementById('diffStars');
const herStarsEl  = document.getElementById('herStars');
const himStarsEl  = document.getElementById('himStars');

/* ===== Small helpers ===== */
function stars(n){return '‚òÖ'.repeat(n||0) + '‚òÜ'.repeat(5-(n||0))}
function getRatingFor(id){ if(!ratings[id]) ratings[id]={diff:0,her:0,him:0}; return ratings[id]; }
function saveRatings(){ localStorage.setItem(LSK_RATINGS, JSON.stringify(ratings)); }
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } }

/* ===== IndexedDB minimal ===== */
function openDB(){return new Promise((res,rej)=>{const r=indexedDB.open(DB_NAME,1);r.onupgradeneeded=e=>{const db=e.target.result; if(!db.objectStoreNames.contains(DB_STORE)){const s=db.createObjectStore(DB_STORE,{keyPath:'id'}); s.createIndex('ts','ts');}}; r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error);});}
function dbAddMany(items){return new Promise((res,rej)=>{const tx=db.transaction(DB_STORE,'readwrite'),st=tx.objectStore(DB_STORE);items.forEach(it=>st.put(it));tx.oncomplete=()=>res();tx.onerror=()=>rej(tx.error);});}
function dbGetAll(){return new Promise((res,rej)=>{const tx=db.transaction(DB_STORE,'readonly'),st=tx.objectStore(DB_STORE),rq=st.getAll();rq.onsuccess=()=>res(rq.result||[]);rq.onerror=()=>rej(rq.error);});}

/* ===== Build Restrict dropdown ===== */
function buildRestrict(){
  mainRestrict.innerHTML='';
  mainRestrict.appendChild(new Option('All categories',''));
  mainRestrict.appendChild(new Option('‚Äî Unassigned ‚Äî','__UNASSIGNED__'));
  CATEGORIES.forEach(c=> mainRestrict.appendChild(new Option(c,c)));
  mainRestrict.value = rigCategory || '';
  mainRestrict.addEventListener('change', ()=>{
    rigCategory = mainRestrict.value;
    localStorage.setItem(LSK_RIG_CAT, JSON.stringify(rigCategory));
  });
}

/* ===== Upload ===== */
fileInput.addEventListener('change', async (e)=>{
  const files=[...e.target.files];
  if(!files.length) return;
  const items=[];
  for(const f of files){
    if(!f.type.startsWith('image/')) continue;
    const id=crypto.randomUUID();
    const blob=f.slice(0,f.size,f.type);
    items.push({id,blob,ts:Date.now(),category:'',weight:1,description:''});
  }
  await dbAddMany(items);
  await reloadImages();
  buildReels();
  fileInput.value='';
});

/* ===== Load images to memory + object URLs ===== */
async function reloadImages(){
  IMAGES = await dbGetAll();
  URLS.forEach(URL.revokeObjectURL); URLS.clear();
  IMAGES.forEach(it=> URLS.set(it.id, URL.createObjectURL(it.blob)));
}

/* ===== Reels ===== */
function buildReels(){
  document.querySelectorAll('.strip').forEach((strip,i)=>{
    strip.innerHTML='';
    if(!IMAGES.length){
      const blank=document.createElement('div'); blank.className='cell'; blank.textContent='‚Äî';
      strip.appendChild(blank); return;
    }
    for(let k=0;k<12;k++){
      const it=IMAGES[(k+i)%IMAGES.length];
      const cell=document.createElement('div'); cell.className='cell';
      const img=new Image(); img.src=URLS.get(it.id);
      cell.appendChild(img); strip.appendChild(cell);
    }
  });
}

/* ===== Pick image with optional category restriction ===== */
function pickImage(){
  let pool = IMAGES.slice();
  if(rigCategory){
    if(rigCategory==='__UNASSIGNED__'){
      pool = pool.filter(x => !(x.category||'').trim());
    }else{
      pool = pool.filter(x => (x.category||'')===rigCategory);
    }
    if(!pool.length) pool = IMAGES.slice(); // fallback if nothing matches
  }
  if(!pool.length) return null;
  return pool[Math.floor(Math.random()*pool.length)];
}

/* ===== Spin / animation ===== */
let spinning=false, blockUntil=0, timerId=null;
spinBtn.addEventListener('click', ()=>{
  if(spinning || Date.now()<blockUntil) return;
  if(!IMAGES.length){ alert('Upload images first'); return; }

  spinning=true;
  revealNameEl.textContent='';
  revealBig.classList.add('hidden');
  revealImg.removeAttribute('src');

  const chosen = pickImage();
  if(!chosen){ spinning=false; return; }

  // choose neighbors to look slot-like
  let others = IMAGES.filter(x=>x.id!==chosen.id);
  if(others.length<2) others = IMAGES.concat(IMAGES);
  shuffle(others);
  const finals=[others[0], chosen, others[1]];

  const strips=[...document.querySelectorAll('.strip')];
  const BASE=20, CELLH=160, ease='cubic-bezier(.12,.62,.22,.99)';
  strips.forEach((strip,i)=>{
    strip.innerHTML='';
    const pool=IMAGES.slice();
    for(let k=0;k<BASE;k++){
      const it=pool[(k+i)%pool.length];
      const cell=document.createElement('div'); cell.className='cell';
      const img=new Image(); img.src=URLS.get(it.id); cell.appendChild(img);
      strip.appendChild(cell);
    }
    const end= document.createElement('div'); end.className='cell';
    const endImg=new Image(); endImg.src=URLS.get(finals[i].id); end.appendChild(endImg);
    strip.appendChild(end);

    strip.style.transition='none';
    strip.style.transform='translateY(0px)';
    strip.style.filter='blur(6px) brightness(0.9)';
    const distance=CELLH*BASE;
    requestAnimationFrame(()=>{ // ensure styles apply
      strip.style.transition=`transform ${SPIN_DURATION_MS/1000}s ${ease}, filter ${SPIN_DURATION_MS/1000}s linear`;
      strip.style.transform=`translateY(-${distance}px)`;
    });
  });

  setTimeout(()=>{
    document.querySelectorAll('.strip').forEach(s=>s.style.filter='none');

    // Reveal chosen
    revealNameEl.textContent = chosen.description || chosen.category || '';
    revealImg.src = URLS.get(chosen.id);
    revealBig.classList.remove('hidden');

    // Show meters for this image
    const r = getRatingFor(chosen.id);
    diffStarsEl.textContent = stars(r.diff);
    herStarsEl.textContent  = stars(r.her);
    himStarsEl.textContent  = stars(r.him);

    // Tap to set stars
    function attach(el,key){
      el.onclick=(evt)=>{
        const rect=el.getBoundingClientRect();
        const rel=(evt.clientX - rect.left)/rect.width; // 0..1
        const val=Math.min(5, Math.max(1, Math.ceil(rel*5)));
        const rr=getRatingFor(chosen.id);
        rr[key]=val; saveRatings();
        el.textContent=stars(val);
      };
    }
    attach(diffStarsEl,'diff'); attach(herStarsEl,'her'); attach(himStarsEl,'him');

    spinning=false;
    if(timerMinutes>0) startCountdown(timerMinutes);
  }, SPIN_DURATION_MS + 60);
});

/* ===== Timer + Skip ===== */
timerSelect.value=String(timerMinutes);
timerSelect.addEventListener('change',()=>{ timerMinutes=+timerSelect.value; localStorage.setItem(LSK_TIMER, JSON.stringify(timerMinutes)); });

function startCountdown(mins){
  const end=Date.now() + mins*60*1000;
  blockUntil=end; spinBtn.disabled=true; skipBtn.style.display='inline-flex';
  if(timerId) clearInterval(timerId);
  timerId=setInterval(()=>{
    const r=end-Date.now();
    if(r<=0){
      clearInterval(timerId); timerId=null; spinBtn.disabled=false; blockUntil=0; countdownEl.textContent=''; skipBtn.style.display='none';
    }else{
      const s=Math.ceil(r/1000), m=Math.floor(s/60), ss=String(s%60).padStart(2,'0');
      countdownEl.textContent = `Next spin in ${m}:${ss}`;
    }
  }, 250);
}
skipBtn.addEventListener('click', ()=>{
  if(timerId) clearInterval(timerId);
  timerId=null; blockUntil=0; spinBtn.disabled=false; countdownEl.textContent=''; skipBtn.style.display='none';
});

/* ===== Boot ===== */
(async function(){
  db = await openDB();
  buildRestrict();
  await reloadImages();
  buildReels();
})();
</script>
</body>
</html>